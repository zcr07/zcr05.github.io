name: Publish Issues

on:
  push:
    paths:
      - 'issues/*.md'

permissions:
  contents: read
  issues: write

jobs:
  sync-issues:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # ä¸º git diff æä¾›å‰ä¸€æ¬¡æäº¤ä¿¡æ¯

      - name: ğŸ› æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        run: |
          echo "ğŸ”§ å½“å‰åˆ†æ”¯ï¼š" $(git rev-parse --abbrev-ref HEAD)
          echo "ğŸ•’ æœ€è¿‘æäº¤ï¼š"
          git log -2 --oneline
          echo "ğŸ“ å½“å‰æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -R

      - name: ğŸ“‚ è·å–æœ¬æ¬¡æäº¤å˜æ›´çš„ issues/*.md æ–‡ä»¶
        id: get_changed_files
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "ğŸ” å½“å‰åˆ†æ”¯ï¼š$BRANCH"

          if [[ "$BRANCH" == "main" ]]; then
            CHANGED_FILES=$(git diff --name-only HEAD^ | grep '^issues/.*\.md$' || true)
          else
            git fetch origin main
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep '^issues/.*\.md$' || true)
          fi

          echo "ğŸ“‚ æœ¬æ¬¡è·å–åˆ°çš„mdæ–‡ä»¶ï¼š$CHANGED_FILES"

          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ“ åˆ›å»ºæˆ–æ›´æ–° Issues
        if: env.CHANGED_FILES != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ“¦ æ­£åœ¨å¤„ç† md æ–‡ä»¶ï¼š"
          echo "$CHANGED_FILES"

          for file in $CHANGED_FILES; do
            echo "ğŸ“„ å‡†å¤‡å¤„ç†ï¼š$file"

            # æå–æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
            FIRST_LINE=$(head -n 1 "$file")
            if [[ "$FIRST_LINE" == ISSUE_LABELS:* ]]; then
              LABELS=$(echo "$FIRST_LINE" | sed 's/^ISSUE_LABELS:[[:space:]]*//' | tr -d '\r')
              BODY=$(tail -n +2 "$file")
              echo "ğŸ·ï¸ æ£€æŸ¥è·å–åˆ°çš„æ ‡ç­¾ï¼š'$LABELS'"
            else
              LABELS=""
              BODY=$(cat "$file")
              echo "â„¹ï¸ æœªè®¾ç½®æ ‡ç­¾"
            fi

            TITLE=$(basename "$file" .md | sed 's/[-_]/ /g')

            echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå issue: '$TITLE'"
            ISSUE_NUMBER=$(gh issue list \
              --state all \
              --search "$TITLE in:title" \
              --json number,title \
              | jq -r ".[] | select(.title==\"$TITLE\") | .number")

            if [[ -n "$ISSUE_NUMBER" ]]; then
              echo "â™»ï¸ æ›´æ–°å·²å­˜åœ¨çš„ issue #$ISSUE_NUMBER"
              if [[ -n "$LABELS" ]]; then
                gh issue edit "$ISSUE_NUMBER" --body "$BODY" --add-label "$LABELS" || echo "âš ï¸ æ ‡ç­¾æ·»åŠ å¤±è´¥ï¼Œå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨"
              else
                gh issue edit "$ISSUE_NUMBER" --body "$BODY"
              fi
            else
              echo "ğŸ†• åˆ›å»ºæ–°çš„ issue: $TITLE"
              if [[ -n "$LABELS" ]]; then
                gh issue create -t "$TITLE" -b "$BODY" --label "$LABELS" || echo "âš ï¸ æ ‡ç­¾åˆ›å»ºå¤±è´¥ï¼Œå¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨"
              else
                gh issue create -t "$TITLE" -b "$BODY"
              fi
            fi

            echo "âœ… å®Œæˆï¼š$TITLE"
          done