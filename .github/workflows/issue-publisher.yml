name: Publish Issues

on:
  push:
    paths:
      - 'issues/*.md'

permissions:
  contents: write  # ä¿®æ”¹ä¸ºwriteä»¥å…è®¸æäº¤æ›´æ”¹
  issues: write

jobs:
  issue-publisher:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2  # ç¡®ä¿è·å–è¶³å¤Ÿçš„å†å²è®°å½•æ¯”è¾ƒå˜æ›´

      - name: ğŸ“‚ è·å–æœ¬æ¬¡æäº¤å˜æ›´çš„ issues/*.md æ–‡ä»¶
        id: get_changed_files
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” å½“å‰ GITHUB_SHA: $GITHUB_SHA"

          # è·å–å‰ä¸€æ¬¡æäº¤çš„SHA
          PREVIOUS_SHA=$(git rev-parse HEAD~1)
          echo "ğŸ”§ å‰ä¸€æ¬¡æäº¤ SHA: $PREVIOUS_SHA"

          # å¤„ç†åˆ é™¤çš„æ–‡ä»¶ - ä½¿ç”¨å•ç‹¬å‘½ä»¤è·å–åˆ é™¤çš„æ–‡ä»¶
          echo "ğŸ“‹ è·å–åˆ é™¤çš„æ–‡ä»¶..."
          git diff --diff-filter=D --name-only $PREVIOUS_SHA $GITHUB_SHA | while read -r file; do
            echo "æ£€æŸ¥åˆ é™¤æ–‡ä»¶: $file"
            # ç§»é™¤å¯èƒ½çš„å¼•å·
            file=$(echo "$file" | sed 's/^"//;s/"$//')
            # è§£ç è½¬ä¹‰åºåˆ—
            decoded_file=$(printf '%b' "$file")
            echo "è§£ç åçš„æ–‡ä»¶è·¯å¾„: $decoded_file"
            
            if [[ "$decoded_file" == issues/* && "$decoded_file" == *.md ]]; then
              echo "ğŸ—‘ï¸ æ£€æµ‹åˆ°åˆ é™¤çš„mdæ–‡ä»¶: $decoded_file"
              # ä¿å­˜åˆ°åˆ é™¤æ–‡ä»¶åˆ—è¡¨
              echo "$decoded_file" >> /tmp/deleted_md_files.txt
            fi
          done
          
          # å¦‚æœåˆ é™¤æ–‡ä»¶åˆ—è¡¨å­˜åœ¨ï¼Œè¯»å–å®ƒ
          DELETED_MD_FILES=""
          if [[ -f "/tmp/deleted_md_files.txt" ]]; then
            DELETED_MD_FILES=$(cat /tmp/deleted_md_files.txt)
          fi
          echo "ğŸ“‚ åˆ é™¤çš„mdæ–‡ä»¶: $DELETED_MD_FILES"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æ“ä½œ
          DELETE_PERFORMED=false
          
          if [[ -n "$DELETED_MD_FILES" ]]; then
            # å¤„ç†æ¯ä¸ªåˆ é™¤çš„æ–‡ä»¶
            while IFS= read -r FILE; do
              echo "ğŸ” å¤„ç†åˆ é™¤çš„æ–‡ä»¶ï¼š$FILE"
              
              # ä»æ–‡ä»¶åè·å–æ ‡é¢˜
              FILENAME=$(basename "$FILE")
              TITLE="${FILENAME%.md}"
              echo "ğŸ“‹ ä»æ–‡ä»¶åæå–æ ‡é¢˜ï¼š$TITLE"
              
              # æŸ¥æ‰¾æ ‡é¢˜å¯¹åº”çš„issue
              ISSUE_NUMBER=$(gh issue list --state all --search "$TITLE in:title" --json number,title | jq -r ".[] | select(.title==\"$TITLE\") | .number")
              echo "æŸ¥æ‰¾issueç»“æœ: $ISSUE_NUMBER"
              
              if [[ -n "$ISSUE_NUMBER" ]]; then
                echo "ğŸ—‘ï¸ æ‰¾åˆ°å¯¹åº”issue #$ISSUE_NUMBERï¼Œå‡†å¤‡å…³é—­..."
                
                # GitHub APIä¸æ”¯æŒç›´æ¥åˆ é™¤issueï¼Œæ”¹ä¸ºä½¿ç”¨gh CLIå°†issueå…³é—­(ä¸é”å®š)
                echo "ğŸ“Œ å…³é—­issue..."
                gh issue close "$ISSUE_NUMBER" --reason "completed" --comment "æ­¤issueå¯¹åº”çš„æ–‡ä»¶å·²è¢«åˆ é™¤ï¼Œè‡ªåŠ¨å…³é—­ã€‚"
                
                echo "âœ… å·²å®Œæˆissue #$ISSUE_NUMBER çš„å¤„ç†"
                DELETE_PERFORMED=true
              else
                echo "âš ï¸ æœªæ‰¾åˆ°ä¸'$TITLE'å¯¹åº”çš„issueï¼Œæ— éœ€åˆ é™¤"
              fi
            done < <(echo "$DELETED_MD_FILES")
          else
            echo "âœ… æ²¡æœ‰åˆ é™¤ä»»ä½•mdæ–‡ä»¶"
          fi

          # è·å–æœ¬æ¬¡æäº¤ä¸­æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶ - ä½¿ç”¨å•ç‹¬å‘½ä»¤è·å–æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
          echo "ğŸ“‹ è·å–æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶..."
          git diff --diff-filter=AM --name-only $PREVIOUS_SHA $GITHUB_SHA | while read -r file; do
            echo "æ£€æŸ¥æ–°å¢/ä¿®æ”¹æ–‡ä»¶: $file"
            # ç§»é™¤å¯èƒ½çš„å¼•å·
            file=$(echo "$file" | sed 's/^"//;s/"$//')
            # è§£ç è½¬ä¹‰åºåˆ—
            decoded_file=$(printf '%b' "$file")
            echo "è§£ç åçš„æ–‡ä»¶è·¯å¾„: $decoded_file"
            
            if [[ "$decoded_file" == issues/* && "$decoded_file" == *.md ]]; then
              echo "ğŸ“ æ£€æµ‹åˆ°æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶: $decoded_file"
              # ä¿å­˜åˆ°ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
              echo "$decoded_file" >> /tmp/modified_md_files.txt
            fi
          done
          
          # å¦‚æœä¿®æ”¹æ–‡ä»¶åˆ—è¡¨å­˜åœ¨ï¼Œè¯»å–å®ƒ
          MODIFIED_MD_FILES=""
          if [[ -f "/tmp/modified_md_files.txt" ]]; then
            MODIFIED_MD_FILES=$(cat /tmp/modified_md_files.txt)
          fi
          echo "ğŸ“‚ æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶: $MODIFIED_MD_FILES"
          
          # å¦‚æœåªæ‰§è¡Œäº†åˆ é™¤æ“ä½œï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶ï¼Œåˆ™ä¸­æ­¢ç¨‹åº
          if [[ "$DELETE_PERFORMED" == "true" && -z "$MODIFIED_MD_FILES" ]]; then
            echo "âœ… å·²å®Œæˆåˆ é™¤æ“ä½œï¼Œæ²¡æœ‰æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶ï¼Œä¸­æ­¢ç¨‹åº"
            echo "HAS_MD_FILES=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # å¦‚æœæ²¡æœ‰éœ€è¦å¤„ç†çš„æ–‡ä»¶ï¼Œåˆ™ä¸­æ­¢ç¨‹åº
          if [[ -z "$MODIFIED_MD_FILES" ]]; then
            echo "âœ… æœ¬æ¬¡æäº¤æ²¡æœ‰æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶ï¼Œä¸­æ­¢ç¨‹åº"
            echo "HAS_MD_FILES=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # æ£€æŸ¥issuesç›®å½•æ˜¯å¦å­˜åœ¨
          if [[ ! -d "issues" ]]; then
            echo "âš ï¸ issuesç›®å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤"
            echo "âœ… å¤„ç†å®Œæ¯•ï¼Œé€€å‡º"
            echo "HAS_MD_FILES=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # å°†æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶å†™å…¥æ–‡ä»¶åˆ—è¡¨ - ç¡®ä¿æ–‡ä»¶çœŸå®å­˜åœ¨
          > /tmp/final_md_files.txt
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              echo "$file" >> /tmp/final_md_files.txt
              echo "âœ… ç¡®è®¤æ–‡ä»¶å­˜åœ¨: $file"
            else
              echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: $file"
            fi
          done < <(echo "$MODIFIED_MD_FILES")
          
          # æ£€æŸ¥æœ€ç»ˆæ–‡ä»¶åˆ—è¡¨æ˜¯å¦ä¸ºç©º
          if [[ ! -s "/tmp/final_md_files.txt" ]]; then
            echo "âš ï¸ æ‰€æœ‰æ–‡ä»¶å‡ä¸å­˜åœ¨ï¼Œä¸­æ­¢ç¨‹åº"
            echo "HAS_MD_FILES=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡æŒ‡å‘æ–‡ä»¶åˆ—è¡¨
          echo "ISSUES_FILES_LIST=/tmp/final_md_files.txt" >> $GITHUB_ENV
          echo "HAS_MD_FILES=true" >> $GITHUB_ENV
          echo "ğŸ“‚ æœ¬æ¬¡å°†å¤„ç†çš„mdæ–‡ä»¶: $(cat /tmp/final_md_files.txt)"

      - name: ğŸ“¦ å¤„ç†Markdownæ–‡ä»¶ä¸­çš„å›¾ç‰‡
        if: env.HAS_MD_FILES == 'true'
        run: |
          # ç¡®ä¿assetsç›®å½•å­˜åœ¨
          mkdir -p assets/images
          
          # å®‰è£…å¿…è¦å·¥å…·
          sudo apt-get update
          sudo apt-get install -y coreutils curl file imagemagick
          
          # è·å–ä»“åº“åŸºç¡€URL
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/main"
          echo "ä»“åº“åŸå§‹æ–‡ä»¶URLåŸºç¡€åœ°å€: $REPO_URL"
          
          # åˆ›å»ºæ–‡ä»¶æ˜ å°„è¡¨ - ç”¨äºè¿½è¸ªå›¾ç‰‡å’Œå®ƒä»¬æ‰€å±çš„mdæ–‡ä»¶
          > /tmp/image_file_map.txt
          
          # æ¸…ç†æ—§å›¾ç‰‡
          while IFS= read -r FILE; do
            echo "å¼€å§‹å¤„ç†æ–‡ä»¶ $FILE çš„å›¾ç‰‡..."
            
            # ä»æ–‡ä»¶åè·å–åŸºæœ¬åç§°ï¼ˆä¸å¸¦æ‰©å±•åï¼‰- ç”¨äºåˆ›å»ºå­ç›®å½•
            BASE_NAME=$(basename "$FILE" .md)
            
            # ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºç‹¬ç«‹çš„å›¾ç‰‡ç›®å½•
            IMG_DIR="assets/images/$BASE_NAME"
            
            # æ¸…ç†æ—§ç›®å½•ä¸­çš„å›¾ç‰‡ (å¦‚æœå­˜åœ¨)
            if [[ -d "$IMG_DIR" ]]; then
              echo "æ¸…ç†æ—§å›¾ç‰‡ç›®å½•: $IMG_DIR"
              rm -rf "$IMG_DIR"
            fi
            
            # åˆ›å»ºæ–°çš„å›¾ç‰‡ç›®å½•
            mkdir -p "$IMG_DIR"
            
            # è®°å½•è¿™ä¸ªæ–‡ä»¶å¯¹åº”çš„å›¾ç‰‡ç›®å½•
            echo "$FILE:$IMG_DIR" >> /tmp/image_file_map.txt
          done < "${{ env.ISSUES_FILES_LIST }}"
          
          # éå†å¤„ç†æ¯ä¸ªmdæ–‡ä»¶ä¸­çš„å›¾ç‰‡
          while IFS= read -r FILE; do
            echo "å¤„ç†æ–‡ä»¶ $FILE ä¸­çš„å›¾ç‰‡"
            
            # è·å–è¿™ä¸ªæ–‡ä»¶çš„å›¾ç‰‡ç›®å½•
            IMG_DIR=$(grep "^$FILE:" /tmp/image_file_map.txt | cut -d':' -f2)
            if [[ -z "$IMG_DIR" ]]; then
              echo "âš ï¸ æ— æ³•æ‰¾åˆ° $FILE çš„å›¾ç‰‡ç›®å½•ï¼Œä½¿ç”¨é»˜è®¤ç›®å½•"
              BASE_NAME=$(basename "$FILE" .md)
              IMG_DIR="assets/images/$BASE_NAME"
              mkdir -p "$IMG_DIR"
            fi
            
            # æš‚å­˜ä¿®æ”¹çŠ¶æ€æ ‡å¿—
            MODIFIED=false
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            TMP_FILE=$(mktemp)
            
            # æå–æ–‡ä»¶ä¸­çš„æ‰€æœ‰å›¾ç‰‡æ ‡è®°
            IMAGE_TAGS=$(grep -o '!\[[^]]*\]([^)]\+)' "$FILE" || echo "")
            
            if [[ -n "$IMAGE_TAGS" ]]; then
              echo "æ£€æµ‹åˆ°å›¾ç‰‡æ ‡è®°: $(echo "$IMAGE_TAGS" | wc -l)ä¸ª"
              
              # å¤„ç†æ¯ä¸ªå›¾ç‰‡æ ‡è®°
              COUNT=1
              while IFS= read -r IMG_TAG; do
                # æå–é“¾æ¥éƒ¨åˆ†
                IMG_URL=$(echo "$IMG_TAG" | grep -o '([^)]\+)' | tr -d '()')
                ALT_TEXT=$(echo "$IMG_TAG" | grep -o '!\[\([^]]*\)\]' | sed 's/!\[\(.*\)\]/\1/')
                
                echo "å¤„ç†å›¾ç‰‡ #$COUNT: $IMG_URL"
                echo "å›¾ç‰‡æ›¿ä»£æ–‡æœ¬: $ALT_TEXT"
                
                # è¿‡æ»¤æ‰å·²ç»æŒ‡å‘ä»“åº“çš„å›¾ç‰‡é“¾æ¥
                if [[ "$IMG_URL" == *"$REPO_URL"* ]]; then
                  echo "å›¾ç‰‡å·²åœ¨ä»“åº“ä¸­ï¼Œè·³è¿‡: $IMG_URL"
                  COUNT=$((COUNT+1))
                  continue
                fi
                
                # ç”Ÿæˆå”¯ä¸€çš„å›¾ç‰‡æ–‡ä»¶å(ä½¿ç”¨åºå·å’ŒåŸå§‹URLçš„å“ˆå¸Œ)
                IMG_NAME=$(echo "$IMG_URL" | md5sum | cut -d' ' -f1)
                SAFE_FILENAME="${COUNT}_${IMG_NAME}"
                
                # æ„å»ºä¸´æ—¶å’Œæœ€ç»ˆæ–‡ä»¶è·¯å¾„
                TMP_IMG_PATH="/tmp/${SAFE_FILENAME}.tmp"
                
                echo "ä¸‹è½½å›¾ç‰‡åˆ°ä¸´æ—¶æ–‡ä»¶: $TMP_IMG_PATH"
                # ä¸‹è½½å›¾ç‰‡åˆ°ä¸´æ—¶ä½ç½®
                curl -s -L -A "Mozilla/5.0" -o "$TMP_IMG_PATH" "$IMG_URL" || true
                
                # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸‹è½½
                if [[ ! -s "$TMP_IMG_PATH" ]]; then
                  echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ·»åŠ å¼•ç”¨å¤´..."
                  curl -s -L -A "Mozilla/5.0" -H "Referer: $IMG_URL" -o "$TMP_IMG_PATH" "$IMG_URL" || true
                fi
                
                # å†æ¬¡æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨å’Œå¤§å°
                if [[ ! -s "$TMP_IMG_PATH" ]]; then
                  echo "âš ï¸ æ‰€æœ‰ä¸‹è½½å°è¯•å‡å¤±è´¥ï¼Œè·³è¿‡æ­¤å›¾ç‰‡"
                  COUNT=$((COUNT+1))
                  continue
                fi
                
                # ä½¿ç”¨fileå‘½ä»¤æ£€æµ‹æ–‡ä»¶ç±»å‹
                FILE_TYPE=$(file -b --mime-type "$TMP_IMG_PATH")
                echo "æ£€æµ‹åˆ°æ–‡ä»¶ç±»å‹: $FILE_TYPE"
                
                # ç¡®å®šæœ€ç»ˆæ‰©å±•å
                case "$FILE_TYPE" in
                  image/jpeg)
                    EXT=".jpg"
                    ;;
                  image/png)
                    EXT=".png"
                    ;;
                  image/gif)
                    EXT=".gif"
                    ;;
                  image/webp)
                    EXT=".webp"
                    ;;
                  image/svg+xml)
                    EXT=".svg"
                    ;;
                  image/*)
                    # é»˜è®¤ç»™å›¾ç‰‡ç±»å‹ç”¨.jpg
                    EXT=".jpg"
                    ;;
                  *)
                    # å¯¹äºéå›¾ç‰‡ç±»å‹ï¼Œå°è¯•è½¬æ¢ä¸ºPNG
                    echo "éå›¾ç‰‡ç±»å‹ $FILE_TYPEï¼Œå°è¯•è½¬æ¢ä¸ºPNG"
                    convert "$TMP_IMG_PATH" "$TMP_IMG_PATH.png" || cp "$TMP_IMG_PATH" "$TMP_IMG_PATH.png"
                    
                    if [[ -s "$TMP_IMG_PATH.png" ]]; then
                      TMP_IMG_PATH="$TMP_IMG_PATH.png"
                      EXT=".png"
                    else
                      # å¦‚æœè½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ‰©å±•å
                      EXT=".jpg"
                    fi
                    ;;
                esac
                
                # æœ€ç»ˆçš„å›¾ç‰‡æ–‡ä»¶è·¯å¾„
                FINAL_IMG_PATH="$IMG_DIR/${SAFE_FILENAME}${EXT}"
                
                # ç§»åŠ¨å›¾ç‰‡åˆ°æœ€ç»ˆä½ç½®
                echo "ä¿å­˜å›¾ç‰‡åˆ°: $FINAL_IMG_PATH"
                mv "$TMP_IMG_PATH" "$FINAL_IMG_PATH"
                
                # æ„å»ºæ–°çš„å›¾ç‰‡URL
                REPO_IMG_URL="$REPO_URL/$FINAL_IMG_PATH"
                echo "æ–°å›¾ç‰‡URL: $REPO_IMG_URL"
                
                # æ„å»ºæ–°çš„å®Œæ•´å›¾ç‰‡æ ‡è®°
                NEW_IMG_TAG="![$ALT_TEXT]($REPO_IMG_URL)"
                
                # è½¬ä¹‰ç”¨äºsedçš„ç‰¹æ®Šå­—ç¬¦
                IMG_TAG_ESCAPED=$(echo "$IMG_TAG" | sed 's/[\/&]/\\&/g')
                NEW_IMG_TAG_ESCAPED=$(echo "$NEW_IMG_TAG" | sed 's/[\/&]/\\&/g')
                
                # æ›¿æ¢Markdownæ–‡ä»¶ä¸­çš„å›¾ç‰‡é“¾æ¥
                cat "$FILE" > "$TMP_FILE"
                sed -i "s|$IMG_TAG_ESCAPED|$NEW_IMG_TAG_ESCAPED|g" "$TMP_FILE"
                
                # æ£€æŸ¥æ›¿æ¢æ˜¯å¦æˆåŠŸ
                if cmp -s "$FILE" "$TMP_FILE"; then
                  echo "âš ï¸ æ›¿æ¢å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨perl..."
                  cat "$FILE" > "$TMP_FILE"
                  perl -i -0 -pe "s|\Q$IMG_TAG\E|$NEW_IMG_TAG|g" "$TMP_FILE"
                  
                  if cmp -s "$FILE" "$TMP_FILE"; then
                    echo "âš ï¸ perlæ›¿æ¢ä¹Ÿå¤±è´¥ï¼Œå°è¯•åŸå§‹URLç›´æ¥æ›¿æ¢..."
                    IMG_URL_ESCAPED=$(echo "$IMG_URL" | sed 's/[\/&]/\\&/g')
                    REPO_IMG_URL_ESCAPED=$(echo "$REPO_IMG_URL" | sed 's/[\/&]/\\&/g')
                    
                    cat "$FILE" > "$TMP_FILE"
                    sed -i "s|$IMG_URL_ESCAPED|$REPO_IMG_URL_ESCAPED|g" "$TMP_FILE"
                    
                    if cmp -s "$FILE" "$TMP_FILE"; then
                      echo "âš ï¸ æ‰€æœ‰æ›¿æ¢æ–¹æ³•å‡å¤±è´¥ï¼Œè·³è¿‡æ­¤å›¾ç‰‡"
                      COUNT=$((COUNT+1))
                      continue
                    fi
                  fi
                fi
                
                # å†™å›Markdownæ–‡ä»¶
                cat "$TMP_FILE" > "$FILE"
                echo "âœ… æˆåŠŸæ›¿æ¢å›¾ç‰‡é“¾æ¥: $IMG_URL -> $REPO_IMG_URL"
                MODIFIED=true
                COUNT=$((COUNT+1))
              done < <(echo "$IMAGE_TAGS")
            else
              echo "å°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ³•æ£€æµ‹å›¾ç‰‡é“¾æ¥..."
              # å¦ä¸€ç§æ£€æµ‹æ–¹æ³• - é’ˆå¯¹ç‰¹æ®Šæ ¼å¼çš„å›¾ç‰‡é“¾æ¥
              IMAGE_LINKS=$(grep -o '!\[.*\](http[^)]*' "$FILE" | sed 's/!\[.*\](//' || echo "")
              
              if [[ -n "$IMAGE_LINKS" ]]; then
                echo "ä½¿ç”¨å¤‡ç”¨æ–¹å¼æ£€æµ‹åˆ° $(echo "$IMAGE_LINKS" | wc -l) ä¸ªå›¾ç‰‡é“¾æ¥"
                
                COUNT=1
                while IFS= read -r IMG_URL; do
                  echo "å¤„ç†å¤‡ç”¨æ¨¡å¼å›¾ç‰‡ #$COUNT: $IMG_URL"
                  
                  # è¿‡æ»¤æ‰å·²ç»æŒ‡å‘ä»“åº“çš„å›¾ç‰‡é“¾æ¥
                  if [[ "$IMG_URL" == *"$REPO_URL"* ]]; then
                    echo "å›¾ç‰‡å·²åœ¨ä»“åº“ä¸­ï¼Œè·³è¿‡: $IMG_URL"
                    COUNT=$((COUNT+1))
                    continue
                  fi
                  
                  # ç”Ÿæˆå”¯ä¸€çš„å›¾ç‰‡æ–‡ä»¶å
                  IMG_NAME=$(echo "$IMG_URL" | md5sum | cut -d' ' -f1)
                  SAFE_FILENAME="alt_${COUNT}_${IMG_NAME}"
                  
                  # æ„å»ºä¸´æ—¶å’Œæœ€ç»ˆæ–‡ä»¶è·¯å¾„
                  TMP_IMG_PATH="/tmp/${SAFE_FILENAME}.tmp"
                  
                  # ä¸‹è½½å›¾ç‰‡åˆ°ä¸´æ—¶ä½ç½®
                  curl -s -L -A "Mozilla/5.0" -o "$TMP_IMG_PATH" "$IMG_URL" || true
                  
                  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸‹è½½
                  if [[ ! -s "$TMP_IMG_PATH" ]]; then
                    echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ·»åŠ å¼•ç”¨å¤´..."
                    curl -s -L -A "Mozilla/5.0" -H "Referer: $IMG_URL" -o "$TMP_IMG_PATH" "$IMG_URL" || true
                  fi
                  
                  # å†æ¬¡æ£€æŸ¥æ–‡ä»¶
                  if [[ ! -s "$TMP_IMG_PATH" ]]; then
                    echo "âš ï¸ æ‰€æœ‰ä¸‹è½½å°è¯•å‡å¤±è´¥ï¼Œè·³è¿‡æ­¤å›¾ç‰‡"
                    COUNT=$((COUNT+1))
                    continue
                  fi
                  
                  # ä½¿ç”¨fileå‘½ä»¤æ£€æµ‹æ–‡ä»¶ç±»å‹
                  FILE_TYPE=$(file -b --mime-type "$TMP_IMG_PATH")
                  echo "æ£€æµ‹åˆ°æ–‡ä»¶ç±»å‹: $FILE_TYPE"
                  
                  # ç¡®å®šæ‰©å±•å
                  case "$FILE_TYPE" in
                    image/jpeg)
                      EXT=".jpg"
                      ;;
                    image/png)
                      EXT=".png"
                      ;;
                    image/gif)
                      EXT=".gif"
                      ;;
                    image/webp)
                      EXT=".webp"
                      ;;
                    image/svg+xml)
                      EXT=".svg"
                      ;;
                    image/*)
                      # é»˜è®¤å›¾ç‰‡æ‰©å±•å
                      EXT=".jpg"
                      ;;
                    *)
                      # å¯¹äºéå›¾ç‰‡ç±»å‹ï¼Œå°è¯•è½¬æ¢
                      echo "éå›¾ç‰‡ç±»å‹ $FILE_TYPEï¼Œå°è¯•è½¬æ¢ä¸ºPNG"
                      convert "$TMP_IMG_PATH" "$TMP_IMG_PATH.png" || cp "$TMP_IMG_PATH" "$TMP_IMG_PATH.png"
                      
                      if [[ -s "$TMP_IMG_PATH.png" ]]; then
                        TMP_IMG_PATH="$TMP_IMG_PATH.png"
                        EXT=".png"
                      else
                        EXT=".jpg"
                      fi
                      ;;
                  esac
                  
                  # æœ€ç»ˆçš„å›¾ç‰‡æ–‡ä»¶è·¯å¾„
                  FINAL_IMG_PATH="$IMG_DIR/${SAFE_FILENAME}${EXT}"
                  
                  # ç§»åŠ¨å›¾ç‰‡åˆ°æœ€ç»ˆä½ç½®
                  echo "ä¿å­˜å›¾ç‰‡åˆ°: $FINAL_IMG_PATH"
                  mv "$TMP_IMG_PATH" "$FINAL_IMG_PATH"
                  
                  # æ„å»ºæ–°çš„å›¾ç‰‡URL
                  REPO_IMG_URL="$REPO_URL/$FINAL_IMG_PATH"
                  echo "æ–°å›¾ç‰‡URL: $REPO_IMG_URL"
                  
                  # æ›¿æ¢Markdownæ–‡ä»¶ä¸­çš„å›¾ç‰‡é“¾æ¥
                  IMG_URL_ESCAPED=$(echo "$IMG_URL" | sed 's/[\/&]/\\&/g')
                  REPO_IMG_URL_ESCAPED=$(echo "$REPO_IMG_URL" | sed 's/[\/&]/\\&/g')
                  
                  cat "$FILE" > "$TMP_FILE"
                  sed -i "s|$IMG_URL_ESCAPED|$REPO_IMG_URL_ESCAPED|g" "$TMP_FILE"
                  
                  # æ£€æŸ¥æ›¿æ¢æ˜¯å¦æˆåŠŸ
                  if cmp -s "$FILE" "$TMP_FILE"; then
                    echo "âš ï¸ æ›¿æ¢å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨perl..."
                    cat "$FILE" > "$TMP_FILE"
                    perl -i -pe "s|\Q$IMG_URL\E|$REPO_IMG_URL|g" "$TMP_FILE"
                    
                    if cmp -s "$FILE" "$TMP_FILE"; then
                      echo "âš ï¸ æ‰€æœ‰æ›¿æ¢æ–¹æ³•å‡å¤±è´¥ï¼Œè·³è¿‡æ­¤å›¾ç‰‡"
                      COUNT=$((COUNT+1))
                      continue
                    fi
                  fi
                  
                  # å†™å›Markdownæ–‡ä»¶
                  cat "$TMP_FILE" > "$FILE"
                  echo "âœ… æˆåŠŸæ›¿æ¢å›¾ç‰‡é“¾æ¥: $IMG_URL -> $REPO_IMG_URL"
                  MODIFIED=true
                  COUNT=$((COUNT+1))
                done < <(echo "$IMAGE_LINKS")
              else
                echo "æ‰€æœ‰æ–¹æ³•å‡æœªæ£€æµ‹åˆ°å›¾ç‰‡é“¾æ¥ï¼Œæ— éœ€å¤„ç†"
              fi
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "$TMP_FILE"
            
            if [[ "$MODIFIED" == "true" ]]; then
              echo "âœ… æ–‡ä»¶ $FILE ä¸­çš„å›¾ç‰‡é“¾æ¥å·²æ›´æ–°"
            else
              echo "â„¹ï¸ æ–‡ä»¶ $FILE æ— éœ€ä¿®æ”¹æˆ–æœªæ£€æµ‹åˆ°å›¾ç‰‡"
            fi
          done < "${{ env.ISSUES_FILES_LIST }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [[ -n "$(git status --porcelain assets/images/)" || -n "$(git status --porcelain issues/)" ]]; then
            echo "ğŸ‘‰ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæäº¤æ›´æ–°çš„å›¾ç‰‡å’ŒMarkdownæ–‡ä»¶"
            
            # éªŒè¯GitHub Issueä¸­çš„å›¾ç‰‡æ˜¯å¦æ­£ç¡®
            echo "âœ… éªŒè¯å¤„ç†åçš„Markdownæ–‡ä»¶..."
            
            # é‡æ–°æ£€æŸ¥æ‰€æœ‰å¤„ç†è¿‡çš„Markdownæ–‡ä»¶
            while IFS= read -r FILE; do
              echo "æ£€æŸ¥æ–‡ä»¶: $FILE"
              
              # ç¡®è®¤æ‰€æœ‰å›¾ç‰‡é“¾æ¥éƒ½æŒ‡å‘ä»“åº“
              REPO_LINKS_COUNT=$(grep -o "!\[.*\](${REPO_URL}[^)]\+)" "$FILE" | wc -l)
              EXTERNAL_LINKS_COUNT=$(grep -o '!\[.*\](http[^)]\+)' "$FILE" | grep -v "$REPO_URL" | wc -l)
              
              echo "ä»“åº“å†…é“¾æ¥: $REPO_LINKS_COUNT, å¤–éƒ¨é“¾æ¥: $EXTERNAL_LINKS_COUNT"
              
              if [[ $EXTERNAL_LINKS_COUNT -gt 0 ]]; then
                echo "âš ï¸ è­¦å‘Š: æ–‡ä»¶ $FILE ä¸­ä»æœ‰ $EXTERNAL_LINKS_COUNT ä¸ªå¤–éƒ¨å›¾ç‰‡é“¾æ¥"
              else
                echo "âœ“ æ–‡ä»¶ $FILE ä¸­çš„æ‰€æœ‰å›¾ç‰‡é“¾æ¥å·²æŒ‡å‘ä»“åº“"
              fi
            done < "${{ env.ISSUES_FILES_LIST }}"
            
            # é…ç½®Git
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # æ·»åŠ å¹¶æäº¤æ›´æ”¹
            git add assets/images/
            git add issues/
            git commit -m "ğŸ–¼ï¸ å°†å›¾ç‰‡è½¬å‚¨åˆ°ä»“åº“å¹¶æ›´æ–°Markdowné“¾æ¥" || echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            
            # æ¨é€æ›´æ”¹
            git push
            
            echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
          else
            echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æäº¤çš„æ›´æ”¹"
          fi

      - name: ğŸ“„ å¤„ç†æ¯ä¸ªmdæ–‡ä»¶
        id: process_files
        if: env.HAS_MD_FILES == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨æ˜¯å¦å­˜åœ¨
          if [[ ! -f "${{ env.ISSUES_FILES_LIST }}" ]]; then
            echo "âŒ æ–‡ä»¶åˆ—è¡¨ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†"
            exit 0
          fi
          
          # æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨æ˜¯å¦ä¸ºç©º
          if [[ ! -s "${{ env.ISSUES_FILES_LIST }}" ]]; then
            echo "âŒ æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†"
            exit 0
          fi
          
          echo "ğŸ“‚ è¯»å–mdæ–‡ä»¶åˆ—è¡¨: $(cat ${{ env.ISSUES_FILES_LIST }})"
          
          # å…ˆè·å–å½“å‰ä»“åº“å·²æœ‰çš„æ‰€æœ‰æ ‡ç­¾
          echo "ğŸ“‹ è·å–ä»“åº“ç°æœ‰æ ‡ç­¾..."
          EXISTING_LABELS=$(gh label list --json name | jq -r '.[].name')
          echo "ğŸ“‹ ç°æœ‰æ ‡ç­¾: $EXISTING_LABELS"
          
          # éå†æ–‡ä»¶åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ–‡ä»¶
          while IFS= read -r FILE; do
            echo "ğŸ” å¤„ç†æ–‡ä»¶ï¼š$FILE"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [[ ! -f "$FILE" ]]; then
              echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼š$FILEï¼Œè·³è¿‡å¤„ç†"
              continue
            fi
            
            # ä»æ–‡ä»¶åè·å–æ ‡é¢˜ï¼ˆç§»é™¤æ‰©å±•åå’Œè·¯å¾„ï¼‰
            FILENAME=$(basename "$FILE")
            TITLE="${FILENAME%.md}"
            echo "ğŸ“‹ ä»æ–‡ä»¶åæå–æ ‡é¢˜ï¼š$TITLE"
            
            # ä»æ–‡ä»¶å†…å®¹è·å–æ ‡ç­¾
            LABELS=$(grep -E '^ISSUE_LABELS:' "$FILE" | sed 's/^ISSUE_LABELS:[[:space:]]*//' || echo "æ–‡æ¡£")
            
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤æ ‡ç­¾
            if [[ -z "$LABELS" ]]; then
              LABELS="æ–‡æ¡£"
            fi
            echo "ğŸ“‹ æå–æ ‡ç­¾ï¼š$LABELS"
            
            # å¤„ç†æ ‡ç­¾ï¼Œå°†é€—å·åˆ†éš”çš„æ ‡ç­¾è½¬æ¢ä¸ºæ•°ç»„
            LABEL_ARRAY=()
            IFS=',' read -ra TEMP_ARRAY <<< "$LABELS"
            for label in "${TEMP_ARRAY[@]}"; do
              # å»é™¤æ ‡ç­¾ä¸¤ç«¯çš„ç©ºæ ¼
              LABEL_ARRAY+=("$(echo "$label" | xargs)")
            done
            echo "ğŸ“‹ è§£æçš„æ ‡ç­¾ï¼š${LABEL_ARRAY[*]}"
            
            # ç¡®ä¿æ ‡ç­¾åœ¨ä»“åº“ä¸­å­˜åœ¨
            for label in "${LABEL_ARRAY[@]}"; do
              if ! echo "$EXISTING_LABELS" | grep -q "^$label$"; then
                echo "ğŸ·ï¸ åˆ›å»ºæ–°æ ‡ç­¾: $label"
                # åˆ›å»ºæ ‡ç­¾ï¼Œä½¿ç”¨éšæœºé¢œè‰²
                COLORS=("fc8403" "2cbe4e" "0075ca" "d73a4a" "6f42c1" "fbca04" "b60205" "5319e7" "0e8a16" "1d76db" "c5def5" "bfdadc")
                RANDOM_COLOR=${COLORS[$((RANDOM % ${#COLORS[@]}))]}
                gh label create "$label" --color "$RANDOM_COLOR" || true
              else
                echo "ğŸ·ï¸ æ ‡ç­¾å·²å­˜åœ¨: $label"
              fi
            done
            
            # ä»æ–‡ä»¶ä¸­æå–æ­£æ–‡å†…å®¹ï¼ˆè·³è¿‡æ ‡ç­¾è¡Œï¼‰
            # å°†å†…å®¹ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å…Shellå‘½ä»¤æ³¨å…¥å’Œç‰¹æ®Šå­—ç¬¦é—®é¢˜
            grep -v '^ISSUE_LABELS:' "$FILE" > /tmp/issue_body.md
            echo "ğŸ“‹ æå–æ­£æ–‡å†…å®¹é•¿åº¦ï¼š$(wc -c < /tmp/issue_body.md) å­—èŠ‚"

            # æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå issue
            ISSUE_NUMBER=$(gh issue list --state all --search "$TITLE in:title" --json number,title,state | jq -r ".[] | select(.title==\"$TITLE\") | .number")
            
            # å¦‚æœæ‰¾åˆ° issueï¼Œåˆ™æ›´æ–°ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„ issue
            if [[ -n "$ISSUE_NUMBER" ]]; then
              # è·å–issueçŠ¶æ€
              ISSUE_STATE=$(gh issue view "$ISSUE_NUMBER" --json state | jq -r '.state')
              echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå issue: '$TITLE'ï¼Œæ‰¾åˆ° issue number: $ISSUE_NUMBERï¼ŒçŠ¶æ€: $ISSUE_STATE"
              
              # å¦‚æœissueæ˜¯å…³é—­çŠ¶æ€ï¼Œå…ˆé‡æ–°æ‰“å¼€
              if [[ "$ISSUE_STATE" == "CLOSED" ]]; then
                echo "ğŸ”“ é‡æ–°æ‰“å¼€å·²å…³é—­çš„issue #$ISSUE_NUMBER"
                gh issue reopen "$ISSUE_NUMBER"
              fi
              
              echo "â™»ï¸ æ›´æ–°å·²å­˜åœ¨çš„ issue #$ISSUE_NUMBER"
              
              # æ›´æ–°issueå†…å®¹
              gh issue edit "$ISSUE_NUMBER" --body-file /tmp/issue_body.md
              
              # è·å–issueç°æœ‰æ ‡ç­¾
              CURRENT_LABELS=$(gh issue view "$ISSUE_NUMBER" --json labels | jq -r '.labels[].name')
              echo "ğŸ·ï¸ ç°æœ‰æ ‡ç­¾: $CURRENT_LABELS"
              
              # æ·»åŠ mdæ–‡ä»¶ä¸­çš„æ–°æ ‡ç­¾
              echo "ğŸ·ï¸ æ·»åŠ æ–°æ ‡ç­¾..."
              for label in "${LABEL_ARRAY[@]}"; do
                # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨äºissueä¸­
                if ! echo "$CURRENT_LABELS" | grep -q "^$label$"; then
                  echo "ğŸ·ï¸ æ·»åŠ æ–°æ ‡ç­¾: $label"
                  gh issue edit "$ISSUE_NUMBER" --add-label "$label"
                else
                  echo "ğŸ·ï¸ æ ‡ç­¾å·²å­˜åœ¨: $label"
                fi
              done
            else
              echo "ğŸ†• åˆ›å»ºæ–°çš„ issue: $TITLE"
              
              # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶åŒ…å«æ ‡ç­¾å‚æ•°
              LABEL_PARAMS=""
              for label in "${LABEL_ARRAY[@]}"; do
                LABEL_PARAMS+=" --label \"$label\""
              done
              
              # ä½¿ç”¨body-fileå’Œæ ‡ç­¾åˆ›å»ºissue
              eval "gh issue create -t \"$TITLE\" --body-file /tmp/issue_body.md $LABEL_PARAMS"
            fi

            echo "âœ… å®Œæˆï¼š$TITLE"
          done < "${{ env.ISSUES_FILES_LIST }}"