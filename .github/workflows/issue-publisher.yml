name: Publish Issues

on:
  workflow_dispatch:
  push:
    paths:
      - 'issues/*.md'

permissions:
  contents: write
  issues: write

jobs:
  issue-publisher:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2  # ç¡®ä¿è·å–è¶³å¤Ÿçš„å†å²è®°å½•æ¯”è¾ƒå˜æ›´
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨å¸¦å†™æƒé™çš„token

      - name: ğŸ“‚ è·å–æœ¬æ¬¡æäº¤å˜æ›´çš„ issues/*.md æ–‡ä»¶
        id: get_changed_files
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” å½“å‰ GITHUB_SHA: $GITHUB_SHA"

          # è·å–å‰ä¸€æ¬¡æäº¤çš„SHA
          PREVIOUS_SHA=$(git rev-parse HEAD~1)
          echo "ğŸ”§ å‰ä¸€æ¬¡æäº¤ SHA: $PREVIOUS_SHA"

          # å¤„ç†åˆ é™¤çš„æ–‡ä»¶ - ä½¿ç”¨å•ç‹¬å‘½ä»¤è·å–åˆ é™¤çš„æ–‡ä»¶
          echo "ğŸ“‹ è·å–åˆ é™¤çš„æ–‡ä»¶..."
          git diff --diff-filter=D --name-only $PREVIOUS_SHA $GITHUB_SHA | while read -r file; do
            echo "æ£€æŸ¥åˆ é™¤æ–‡ä»¶: $file"
            # ç§»é™¤å¯èƒ½çš„å¼•å·
            file=$(echo "$file" | sed 's/^"//;s/"$//')
            # è§£ç è½¬ä¹‰åºåˆ—
            decoded_file=$(printf '%b' "$file")
            echo "è§£ç åçš„æ–‡ä»¶è·¯å¾„: $decoded_file"
            
            if [[ "$decoded_file" == issues/* && "$decoded_file" == *.md ]]; then
              echo "ğŸ—‘ï¸ æ£€æµ‹åˆ°åˆ é™¤çš„mdæ–‡ä»¶: $decoded_file"
              # ä¿å­˜åˆ°åˆ é™¤æ–‡ä»¶åˆ—è¡¨
              echo "$decoded_file" >> /tmp/deleted_md_files.txt
            fi
          done
          
          # å¦‚æœåˆ é™¤æ–‡ä»¶åˆ—è¡¨å­˜åœ¨ï¼Œè¯»å–å®ƒ
          DELETED_MD_FILES=""
          if [[ -f "/tmp/deleted_md_files.txt" ]]; then
            DELETED_MD_FILES=$(cat /tmp/deleted_md_files.txt)
          fi
          echo "ğŸ“‚ åˆ é™¤çš„mdæ–‡ä»¶: $DELETED_MD_FILES"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æ“ä½œ
          DELETE_PERFORMED=false
          
          if [[ -n "$DELETED_MD_FILES" ]]; then
            # å¤„ç†æ¯ä¸ªåˆ é™¤çš„æ–‡ä»¶
            while IFS= read -r FILE; do
              echo "ğŸ” å¤„ç†åˆ é™¤çš„æ–‡ä»¶ï¼š$FILE"
              
              # ä»æ–‡ä»¶åè·å–æ ‡é¢˜
              FILENAME=$(basename "$FILE")
              TITLE="${FILENAME%.md}"
              echo "ğŸ“‹ ä»æ–‡ä»¶åæå–æ ‡é¢˜ï¼š$TITLE"
              
              # æŸ¥æ‰¾æ ‡é¢˜å¯¹åº”çš„issue
              ISSUE_NUMBER=$(gh issue list --state all --search "$TITLE in:title" --json number,title | jq -r ".[] | select(.title==\"$TITLE\") | .number")
              echo "æŸ¥æ‰¾issueç»“æœ: $ISSUE_NUMBER"
              
              if [[ -n "$ISSUE_NUMBER" ]]; then
                echo "ğŸ—‘ï¸ æ‰¾åˆ°å¯¹åº”issue #$ISSUE_NUMBERï¼Œå‡†å¤‡å…³é—­..."
                
                # GitHub APIä¸æ”¯æŒç›´æ¥åˆ é™¤issueï¼Œæ”¹ä¸ºä½¿ç”¨gh CLIå°†issueå…³é—­(ä¸é”å®š)
                echo "ğŸ“Œ å…³é—­issue..."
                gh issue close "$ISSUE_NUMBER" --reason "completed" --comment "æ­¤issueå¯¹åº”çš„æ–‡ä»¶å·²è¢«åˆ é™¤ï¼Œè‡ªåŠ¨å…³é—­ã€‚"
                
                echo "âœ… å·²å®Œæˆissue #$ISSUE_NUMBER çš„å¤„ç†"
                DELETE_PERFORMED=true
              else
                echo "âš ï¸ æœªæ‰¾åˆ°ä¸'$TITLE'å¯¹åº”çš„issueï¼Œæ— éœ€åˆ é™¤"
              fi
            done < <(echo "$DELETED_MD_FILES")
          else
            echo "âœ… æ²¡æœ‰åˆ é™¤ä»»ä½•mdæ–‡ä»¶"
          fi

          # è·å–æœ¬æ¬¡æäº¤ä¸­æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶ - ä½¿ç”¨å•ç‹¬å‘½ä»¤è·å–æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
          echo "ğŸ“‹ è·å–æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶..."
          git diff --diff-filter=AM --name-only $PREVIOUS_SHA $GITHUB_SHA | while read -r file; do
            echo "æ£€æŸ¥æ–°å¢/ä¿®æ”¹æ–‡ä»¶: $file"
            # ç§»é™¤å¯èƒ½çš„å¼•å·
            file=$(echo "$file" | sed 's/^"//;s/"$//')
            # è§£ç è½¬ä¹‰åºåˆ—
            decoded_file=$(printf '%b' "$file")
            echo "è§£ç åçš„æ–‡ä»¶è·¯å¾„: $decoded_file"
            
            if [[ "$decoded_file" == issues/* && "$decoded_file" == *.md ]]; then
              echo "ğŸ“ æ£€æµ‹åˆ°æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶: $decoded_file"
              # ä¿å­˜åˆ°ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
              echo "$decoded_file" >> /tmp/modified_md_files.txt
            fi
          done
          
          # å¦‚æœä¿®æ”¹æ–‡ä»¶åˆ—è¡¨å­˜åœ¨ï¼Œè¯»å–å®ƒ
          MODIFIED_MD_FILES=""
          if [[ -f "/tmp/modified_md_files.txt" ]]; then
            MODIFIED_MD_FILES=$(cat /tmp/modified_md_files.txt)
          fi
          echo "ğŸ“‚ æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶: $MODIFIED_MD_FILES"
          
          # å¦‚æœåªæ‰§è¡Œäº†åˆ é™¤æ“ä½œï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶ï¼Œåˆ™æ ‡è®°ä¸ºåªå¤„ç†åˆ é™¤
          if [[ "$DELETE_PERFORMED" == "true" && -z "$MODIFIED_MD_FILES" ]]; then
            echo "âœ… å·²å®Œæˆåˆ é™¤æ“ä½œï¼Œæ²¡æœ‰æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶ï¼Œåªæ‰§è¡Œå›¾ç‰‡æ¸…ç†"
            echo "ONLY_HANDLE_DELETIONS=true" >> $GITHUB_ENV
            echo "HAS_MD_FILES=false" >> $GITHUB_ENV
          fi
          
          # å¦‚æœæ²¡æœ‰éœ€è¦å¤„ç†çš„æ–‡ä»¶ï¼Œåˆ™ä¸­æ­¢ç¨‹åº
          if [[ -z "$MODIFIED_MD_FILES" && "$DELETE_PERFORMED" != "true" ]]; then
            echo "âœ… æœ¬æ¬¡æäº¤æ²¡æœ‰æ–°å¢ã€ä¿®æ”¹æˆ–åˆ é™¤çš„mdæ–‡ä»¶ï¼Œä¸­æ­¢ç¨‹åº"
            echo "HAS_MD_FILES=false" >> $GITHUB_ENV
            echo "ONLY_HANDLE_DELETIONS=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # æ£€æŸ¥issuesç›®å½•æ˜¯å¦å­˜åœ¨
          if [[ ! -d "issues" ]]; then
            echo "âš ï¸ issuesç›®å½•ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤"
            echo "âœ… å¤„ç†å®Œæ¯•ï¼Œé€€å‡º"
            echo "HAS_MD_FILES=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # å°†æ–°å¢æˆ–ä¿®æ”¹çš„mdæ–‡ä»¶å†™å…¥æ–‡ä»¶åˆ—è¡¨ - ç¡®ä¿æ–‡ä»¶çœŸå®å­˜åœ¨
          > /tmp/final_md_files.txt
          while IFS= read -r file; do
            if [[ -f "$file" ]]; then
              echo "$file" >> /tmp/final_md_files.txt
              echo "âœ… ç¡®è®¤æ–‡ä»¶å­˜åœ¨: $file"
            else
              echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: $file"
            fi
          done < <(echo "$MODIFIED_MD_FILES")
          
          # æ£€æŸ¥æœ€ç»ˆæ–‡ä»¶åˆ—è¡¨æ˜¯å¦ä¸ºç©º
          if [[ ! -s "/tmp/final_md_files.txt" ]]; then
            echo "âš ï¸ æ‰€æœ‰æ–‡ä»¶å‡ä¸å­˜åœ¨ï¼Œä¸­æ­¢ç¨‹åº"
            echo "HAS_MD_FILES=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡æŒ‡å‘æ–‡ä»¶åˆ—è¡¨
          echo "ISSUES_FILES_LIST=/tmp/final_md_files.txt" >> $GITHUB_ENV
          echo "HAS_MD_FILES=true" >> $GITHUB_ENV
          echo "ğŸ“‚ æœ¬æ¬¡å°†å¤„ç†çš„mdæ–‡ä»¶: $(cat /tmp/final_md_files.txt)"

      # æ–°å¢ï¼šå¤„ç†Markdownæ–‡ä»¶ä¸­çš„å›¾ç‰‡é“¾æ¥
      - name: ğŸ–¼ï¸ å¤„ç†MDæ–‡ä»¶ä¸­çš„å›¾ç‰‡é“¾æ¥
        id: process_images
        if: env.HAS_MD_FILES == 'true' || env.ONLY_HANDLE_DELETIONS == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # å®‰è£…å¿…è¦çš„å·¥å…·
          echo "ğŸ“Œ å®‰è£…æ‰€éœ€å·¥å…·..."
          sudo apt-get update && sudo apt-get install -y curl jq

          # æ£€æŸ¥ç¯å¢ƒå˜é‡
          echo "ğŸ‘€ æ£€æŸ¥ç¯å¢ƒå˜é‡:"
          echo "  GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "  GITHUB_TOKEN (é•¿åº¦): ${#GH_TOKEN}"
          echo "  GITHUB_SHA: $GITHUB_SHA"
          echo "  ONLY_HANDLE_DELETIONS: ${{ env.ONLY_HANDLE_DELETIONS }}"
          
          # éªŒè¯GitHub CLIæ˜¯å¦å¯ç”¨
          echo "ğŸ‘€ éªŒè¯GitHub CLI:"
          gh --version
          
          # ç¡®ä¿issueæƒé™
          echo "ğŸ‘€ ç¡®è®¤å½“å‰æƒé™èŒƒå›´:"
          gh auth status || echo "âš ï¸ æ— æ³•è·å–æƒé™çŠ¶æ€"

          # ç¡®ä¿Gité…ç½®æ­£ç¡®
          echo "ğŸ‘€ é…ç½®Gitç”¨æˆ·..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦åªå¤„ç†åˆ é™¤
          if [[ "${{ env.ONLY_HANDLE_DELETIONS }}" == "true" ]]; then
            echo "ğŸ§¹ åªå¤„ç†åˆ é™¤æ“ä½œçš„å›¾ç‰‡æ¸…ç†..."
            
            # è¯»å–è¢«åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
            if [[ -f "/tmp/deleted_md_files.txt" ]]; then
              echo "ğŸ“‹ å¤„ç†åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨..."
              
              while IFS= read -r FILE; do
                echo "ğŸ” å¤„ç†åˆ é™¤çš„æ–‡ä»¶ï¼š$FILE"
                
                # è·å–æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰ä½œä¸ºç›®å½•å
                FILE_BASE=$(basename "$FILE" .md)
                FILE_DIR_NAME=$(echo "$FILE_BASE" | tr -c '[:alnum:]' '_' | tr '[:upper:]' '[:lower:]')
                IMG_DIR="assets/images/$FILE_DIR_NAME"
                
                if [[ -d "$IMG_DIR" ]]; then
                  echo "ğŸ—‘ï¸ åˆ é™¤å›¾ç‰‡ç›®å½•: $IMG_DIR"
                  git rm -rf "$IMG_DIR" || echo "âš ï¸ åˆ é™¤ç›®å½•å¤±è´¥: $IMG_DIR"
                else
                  echo "ğŸ‘€ å›¾ç‰‡ç›®å½•ä¸å­˜åœ¨: $IMG_DIR"
                fi
              done < "/tmp/deleted_md_files.txt"
              
              # å¦‚æœæœ‰å›¾ç‰‡å˜åŠ¨ï¼Œæäº¤å¹¶æ¨é€
              if git status --porcelain | grep -q "assets/images/"; then
                echo "ğŸš€ æäº¤å›¾ç‰‡åˆ é™¤æ›´æ”¹..."
                git commit -m "ğŸ—‘ï¸ åˆ é™¤ä¸å†ä½¿ç”¨çš„å›¾ç‰‡ [skip ci]"
                
                echo "ğŸš€ æ¨é€åˆ°GitHub..."
                git push || echo "æ— æ³•æ¨é€åˆ°GitHubï¼Œä½†ç»§ç»­æ‰§è¡Œ"
              else
                echo "â„¹ï¸ æ²¡æœ‰å›¾ç‰‡éœ€è¦åˆ é™¤"
              fi
            else
              echo "âš ï¸ åˆ é™¤æ–‡ä»¶åˆ—è¡¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¸…ç†å›¾ç‰‡"
            fi
            
            echo "âœ… åˆ é™¤æ“ä½œçš„å›¾ç‰‡æ¸…ç†å®Œæˆ"
            exit 0
          fi
          
          # å¤„ç†æ¯ä¸ªéœ€è¦æ›´æ–°çš„Markdownæ–‡ä»¶ï¼ˆä»…å½“å‰æäº¤çš„æ–‡ä»¶ï¼‰
          while IFS= read -r FILE; do
            echo "ğŸ” å¤„ç†å½“å‰æäº¤çš„æ–‡ä»¶ï¼š$FILE"
            
            # è·å–æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰ä½œä¸ºç›®å½•å
            FILE_BASE=$(basename "$FILE" .md)
            FILE_DIR_NAME=$(echo "$FILE_BASE" | tr -c '[:alnum:]' '_' | tr '[:upper:]' '[:lower:]')
            echo "ğŸ‘€ ä¸ºæ–‡ä»¶åˆ›å»ºå›¾ç‰‡ç›®å½•: $FILE_DIR_NAME"
            
            # åˆ›å»º/æ¸…ç©ºå›¾ç‰‡ç›®å½• - å®ç°å…¨é‡æ›´æ–°
            IMG_DIR="assets/images/$FILE_DIR_NAME"
            if [[ -d "$IMG_DIR" ]]; then
              echo "ğŸ§¹ æ¸…ç©ºç°æœ‰å›¾ç‰‡ç›®å½•ï¼Œå‡†å¤‡å…¨é‡æ›´æ–°: $IMG_DIR"
              rm -rf "$IMG_DIR"/*
            fi
            
            # ç¡®ä¿å›¾ç‰‡ç›®å½•å­˜åœ¨
            mkdir -p "$IMG_DIR"
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            TMP_FILE=$(mktemp)
            echo "ğŸ‘€ ä¸´æ—¶æ–‡ä»¶è·¯å¾„: $TMP_FILE"
            
            # å¤åˆ¶åŸå§‹æ–‡ä»¶å†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶
            cp "$FILE" "$TMP_FILE"
            echo "ğŸ‘€ åŸå§‹æ–‡ä»¶å¤§å°: $(wc -c < "$FILE") å­—èŠ‚"
            
            # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾æ‰€æœ‰å›¾ç‰‡é“¾æ¥ - åŒ…æ‹¬GitHubå’Œå¤–éƒ¨é“¾æ¥
            echo "ğŸ‘€ å¼€å§‹æŸ¥æ‰¾æ‰€æœ‰å›¾ç‰‡é“¾æ¥..."
            ALL_IMAGES=$(grep -oE '!\[[^]]*\]\([^)]+\)|!\[\]\([^)]+\)' "$FILE" || echo "")
            
            echo "ğŸ‘€ æ‰¾åˆ°å›¾ç‰‡é“¾æ¥æ•°é‡: $(echo "$ALL_IMAGES" | grep -c '^' || echo 0)"
            
            # åˆ†ç¦»GitHubé“¾æ¥å’Œå¤–éƒ¨é“¾æ¥
            GITHUB_IMAGES=$(echo "$ALL_IMAGES" | grep 'github.com\|githubusercontent.com' || echo "")
            EXTERNAL_IMAGES=$(echo "$ALL_IMAGES" | grep -v 'github.com\|githubusercontent.com' || echo "")
            
            echo "ğŸ‘€ GitHubå›¾ç‰‡é“¾æ¥æ•°: $(echo "$GITHUB_IMAGES" | grep -c '^' || echo 0)"
            echo "ğŸ‘€ å¤–éƒ¨å›¾ç‰‡é“¾æ¥æ•°: $(echo "$EXTERNAL_IMAGES" | grep -c '^' || echo 0)"
            
            # å¤„ç†å·²æœ‰çš„GitHubå›¾ç‰‡é“¾æ¥ - ä¸‹è½½åˆ°æœ¬åœ°
            if [[ -n "$GITHUB_IMAGES" ]]; then
              echo "ğŸ–¼ï¸ å¤„ç†ç°æœ‰GitHubå›¾ç‰‡é“¾æ¥..."
              
              echo "$GITHUB_IMAGES" | while read -r IMG_LINK; do
                # æå–é“¾æ¥éƒ¨åˆ†
                IMG_URL=$(echo "$IMG_LINK" | grep -oE 'https://[^)]+')
                
                if [[ -n "$IMG_URL" ]]; then
                  echo "ğŸ“¥ ä¸‹è½½GitHubå›¾ç‰‡: $IMG_URL"
                  
                  # è·å–æ–‡ä»¶å
                  IMG_FILENAME=$(basename "$IMG_URL")
                  
                  # åˆ›å»ºä¸´æ—¶å›¾ç‰‡æ–‡ä»¶
                  IMG_TMP=$(mktemp)
                  
                  # ä¸‹è½½å›¾ç‰‡
                  curl -L "$IMG_URL" -o "$IMG_TMP"
                  
                  if [[ -f "$IMG_TMP" && -s "$IMG_TMP" ]]; then
                    # å¤åˆ¶åˆ°å›¾ç‰‡ç›®å½•
                    cp "$IMG_TMP" "$IMG_DIR/$IMG_FILENAME"
                    echo "ğŸ‘€ ä¿å­˜GitHubå›¾ç‰‡åˆ°: $IMG_DIR/$IMG_FILENAME"
                    
                    # ç”Ÿæˆæ–°çš„GitHubæ ¼å¼å›¾ç‰‡URL
                    REPO_URL="https://raw.githubusercontent.com/$GITHUB_REPOSITORY"
                    BRANCH="${GITHUB_REF#refs/heads/}"
                    if [[ -z "$BRANCH" ]]; then
                      BRANCH="main"
                    fi
                    NEW_IMG_URL="$REPO_URL/$BRANCH/assets/images/$FILE_DIR_NAME/$IMG_FILENAME"
                    
                    # åˆ›å»ºæ–°çš„å›¾ç‰‡Markdowné“¾æ¥
                    if [[ "$IMG_LINK" =~ !\[\] ]]; then
                      NEW_IMG_LINK="![Image]($NEW_IMG_URL)"
                    else
                      ALT_TEXT=$(echo "$IMG_LINK" | sed -E 's/!\[([^]]*)\].*/\1/')
                      NEW_IMG_LINK="![$ALT_TEXT]($NEW_IMG_URL)"
                    fi
                    
                    # æ›¿æ¢åŸå§‹é“¾æ¥
                    perl -i -pe "s/\Q$IMG_LINK\E/$NEW_IMG_LINK/g" "$TMP_FILE" || {
                      FILE_CONTENT=$(<"$TMP_FILE")
                      echo "${FILE_CONTENT//"$IMG_LINK"/"$NEW_IMG_LINK"}" > "$TMP_FILE"
                    }
                  fi
                  
                  # åˆ é™¤ä¸´æ—¶å›¾ç‰‡æ–‡ä»¶
                  rm -f "$IMG_TMP"
                fi
              done
            fi
            
            # å¤„ç†å¤–éƒ¨å›¾ç‰‡é“¾æ¥
            if [[ -n "$EXTERNAL_IMAGES" ]]; then
              echo "ğŸ–¼ï¸ å¤„ç†å¤–éƒ¨å›¾ç‰‡é“¾æ¥..."
              
              # ä¾æ¬¡å¤„ç†æ¯ä¸ªå¤–éƒ¨å›¾ç‰‡é“¾æ¥
              echo "$EXTERNAL_IMAGES" | while read -r IMG_LINK; do
                echo "ğŸ‘€ å¤„ç†å›¾ç‰‡é“¾æ¥: $IMG_LINK"
                
                # æå–å›¾ç‰‡URL
                IMG_URL=$(echo "$IMG_LINK" | grep -oE 'http[^)]+' || echo "")
                
                if [[ -n "$IMG_URL" ]]; then
                  echo "ğŸ“¥ ä¸‹è½½å›¾ç‰‡: $IMG_URL"
                  
                  # åˆ›å»ºä¸´æ—¶å›¾ç‰‡æ–‡ä»¶
                  IMG_TMP=$(mktemp)
                  echo "ğŸ‘€ ä¸´æ—¶å›¾ç‰‡æ–‡ä»¶: $IMG_TMP"
                  
                  # å°è¯•ä¸‹è½½å›¾ç‰‡ï¼Œæ·»åŠ ä¸€äº›é¢å¤–çš„HTTPå¤´
                  echo "ğŸ‘€ å°è¯•ä¸‹è½½å›¾ç‰‡(ä½¿ç”¨é¢å¤–çš„HTTPå¤´)..."
                  curl -v -L \
                    -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" \
                    -H "Accept: image/webp,image/apng,image/*,*/*;q=0.8" \
                    -H "Accept-Language: en-US,en;q=0.9" \
                    -H "Referer: https://www.kdocs.cn/" \
                    "$IMG_URL" -o "$IMG_TMP" 2>&1 | grep -E "^>" || echo "curlè¯¦ç»†è¾“å‡ºè·å–å¤±è´¥"
                  
                  if [[ -f "$IMG_TMP" && -s "$IMG_TMP" ]]; then
                    echo "ğŸ‘€ å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶å¤§å°: $(wc -c < "$IMG_TMP") å­—èŠ‚"
                    echo "ğŸ‘€ æŸ¥çœ‹å›¾ç‰‡ç±»å‹..."
                    file "$IMG_TMP" || echo "æ— æ³•ç¡®å®šæ–‡ä»¶ç±»å‹"
                    
                    # ç¡®å®šå›¾ç‰‡ç±»å‹å’Œæ‰©å±•å
                    MIME_TYPE=$(file -b --mime-type "$IMG_TMP" || echo "image/jpeg")
                    echo "ğŸ‘€ MIMEç±»å‹: $MIME_TYPE"
                    
                    # ä¸ºä¸Šä¼ çš„å›¾ç‰‡ç”Ÿæˆä¸€ä¸ªå”¯ä¸€åç§°
                    # ä½¿ç”¨MD5å“ˆå¸Œæ–‡ä»¶å†…å®¹ä½œä¸ºæ–‡ä»¶åï¼Œä¿è¯å”¯ä¸€æ€§
                    FILE_HASH=$(md5sum "$IMG_TMP" | cut -d ' ' -f 1)
                    FILENAME="img_${FILE_HASH:0:10}"
                    
                    case "$MIME_TYPE" in
                      image/jpeg)
                        EXT=".jpg"
                        ;;
                      image/png)
                        EXT=".png"
                        ;;
                      image/gif)
                        EXT=".gif"
                        ;;
                      image/webp)
                        EXT=".webp"
                        ;;
                      *)
                        EXT=".jpg"  # é»˜è®¤æ‰©å±•å
                        ;;
                    esac
                    
                    FILENAME="${FILENAME}${EXT}"
                    echo "ğŸ‘€ ç”Ÿæˆæ–‡ä»¶å: $FILENAME"
                    
                    # å°†å›¾ç‰‡å­˜å…¥è¯¥æ–‡ä»¶ä¸“å±çš„ç›®å½•
                    IMAGE_PATH="$IMG_DIR/$FILENAME"
                    cp "$IMG_TMP" "$IMAGE_PATH"
                    echo "ğŸ‘€ å¤åˆ¶å›¾ç‰‡åˆ°: $IMAGE_PATH"
                    
                    # æ·»åŠ å›¾ç‰‡åˆ°Git
                    echo "ğŸ‘€ æ·»åŠ å›¾ç‰‡åˆ°Git..."
                    git add "$IMAGE_PATH"
                    
                    # ç”ŸæˆGitHubæ ¼å¼çš„å›¾ç‰‡URL
                    # ä½¿ç”¨ä»“åº“çš„åŸå§‹å†…å®¹é“¾æ¥
                    REPO_URL="https://raw.githubusercontent.com/$GITHUB_REPOSITORY"
                    BRANCH="${GITHUB_REF#refs/heads/}"
                    if [[ -z "$BRANCH" ]]; then
                      BRANCH="main"  # é»˜è®¤åˆ†æ”¯
                    fi
                    GITHUB_IMG_URL="$REPO_URL/$BRANCH/assets/images/$FILE_DIR_NAME/$FILENAME"
                    echo "ğŸ‘€ ç”ŸæˆGitHubå›¾ç‰‡URL: $GITHUB_IMG_URL"
                    
                    # åˆ›å»ºæ–°çš„å›¾ç‰‡Markdownè¯­æ³•
                    if [[ "$IMG_LINK" =~ !\[\] ]]; then
                      NEW_IMG_LINK="![Image]($GITHUB_IMG_URL)"
                    else
                      # æå–åŸå§‹Alt Text
                      ALT_TEXT=$(echo "$IMG_LINK" | sed -E 's/!\[([^]]*)\].*/\1/')
                      NEW_IMG_LINK="![$ALT_TEXT]($GITHUB_IMG_URL)"
                    fi
                    
                    echo "ğŸ‘€ æ–°çš„å›¾ç‰‡é“¾æ¥: $NEW_IMG_LINK"
                    
                    # ä½¿ç”¨ç›´æ¥æ›¿æ¢çš„æ–¹å¼æ›¿æ¢æ–‡ä»¶å†…å®¹
                    echo "ğŸ‘€ æ‰§è¡Œæ›¿æ¢..."
                    # ä½¿ç”¨perlæ›¿ä»£sedï¼Œå¤„ç†ç‰¹æ®Šå­—ç¬¦æ›´å¯é 
                    perl -i -pe "s/\Q$IMG_LINK\E/$NEW_IMG_LINK/g" "$TMP_FILE" || {
                      echo "âš ï¸ Perlæ›¿æ¢å¤±è´¥ï¼Œå°è¯•æ›´ç®€å•çš„æ–¹æ³•"
                      # å°†æ–‡ä»¶å†…å®¹è¯»å…¥å˜é‡å¹¶æ›¿æ¢
                      FILE_CONTENT=$(<"$TMP_FILE")
                      echo "${FILE_CONTENT//"$IMG_LINK"/"$NEW_IMG_LINK"}" > "$TMP_FILE"
                    }
                    
                    echo "ğŸ‘€ æ›¿æ¢åçš„æ–‡ä»¶å¤§å°: $(wc -c < "$TMP_FILE") å­—èŠ‚"
                  else
                    echo "âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
                    if [[ -f "$IMG_TMP" ]]; then
                      echo "ğŸ‘€ æ–‡ä»¶å­˜åœ¨ä½†å¯èƒ½ä¸ºç©ºï¼Œå¤§å°: $(wc -c < "$IMG_TMP") å­—èŠ‚"
                    else
                      echo "ğŸ‘€ æ–‡ä»¶ä¸å­˜åœ¨"
                    fi
                  fi
                  
                  # åˆ é™¤ä¸´æ—¶å›¾ç‰‡æ–‡ä»¶
                  rm -f "$IMG_TMP"
                else
                  echo "âš ï¸ æ— æ³•ä»é“¾æ¥æå–URL: $IMG_LINK"
                fi
              done
            else
              echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°å¤–éƒ¨å›¾ç‰‡é“¾æ¥"
            fi
            
            # ä½¿ç”¨å¤„ç†åçš„å†…å®¹æ›¿æ¢åŸå§‹æ–‡ä»¶
            echo "ğŸ‘€ æ›´æ–°åŸå§‹æ–‡ä»¶..."
            cp "$TMP_FILE" "$FILE"
            echo "ğŸ‘€ æ›´æ–°åçš„æ–‡ä»¶å¤§å°: $(wc -c < "$FILE") å­—èŠ‚"
            
            # æ·»åŠ æ•´ä¸ªå›¾ç‰‡ç›®å½•åˆ°Git
            if [[ -d "$IMG_DIR" ]]; then
              echo "ğŸ‘€ æ·»åŠ å›¾ç‰‡ç›®å½•åˆ°Git: $IMG_DIR"
              git add "$IMG_DIR"
            fi
            
            echo "âœ… å›¾ç‰‡å¤„ç†å®Œæˆ: $FILE"
            
            # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            rm -f "$TMP_FILE"
          done < "${{ env.ISSUES_FILES_LIST }}"
          
          # å¦‚æœæœ‰å›¾ç‰‡å˜åŠ¨ï¼Œæäº¤å¹¶æ¨é€
          if git status --porcelain | grep -q "assets/images/"; then
            echo "ğŸš€ æäº¤å›¾ç‰‡æ›´æ”¹..."
            git commit -m "ğŸ“ æ›´æ–°å›¾ç‰‡èµ„æº [skip ci]"
            
            echo "ğŸš€ æ¨é€åˆ°GitHub..."
            git push || echo "æ— æ³•æ¨é€åˆ°GitHubï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          else
            echo "â„¹ï¸ æ²¡æœ‰å›¾ç‰‡éœ€è¦æäº¤"
          fi

      - name: ğŸ“„ å¤„ç†æ¯ä¸ªmdæ–‡ä»¶
        id: process_files
        if: env.HAS_MD_FILES == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨æ˜¯å¦å­˜åœ¨
          if [[ ! -f "${{ env.ISSUES_FILES_LIST }}" ]]; then
            echo "âŒ æ–‡ä»¶åˆ—è¡¨ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†"
            exit 0
          fi
          
          # æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨æ˜¯å¦ä¸ºç©º
          if [[ ! -s "${{ env.ISSUES_FILES_LIST }}" ]]; then
            echo "âŒ æ–‡ä»¶åˆ—è¡¨ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†"
            exit 0
          fi
          
          echo "ğŸ“‚ è¯»å–mdæ–‡ä»¶åˆ—è¡¨: $(cat ${{ env.ISSUES_FILES_LIST }})"
          
          # å…ˆè·å–å½“å‰ä»“åº“å·²æœ‰çš„æ‰€æœ‰æ ‡ç­¾
          echo "ğŸ“‹ è·å–ä»“åº“ç°æœ‰æ ‡ç­¾..."
          EXISTING_LABELS=$(gh label list --json name | jq -r '.[].name')
          echo "ğŸ“‹ ç°æœ‰æ ‡ç­¾: $EXISTING_LABELS"
          
          # éå†æ–‡ä»¶åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ–‡ä»¶
          while IFS= read -r FILE; do
            echo "ğŸ” å¤„ç†æ–‡ä»¶ï¼š$FILE"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [[ ! -f "$FILE" ]]; then
              echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼š$FILEï¼Œè·³è¿‡å¤„ç†"
              continue
            fi
            
            # ä»æ–‡ä»¶åè·å–æ ‡é¢˜ï¼ˆç§»é™¤æ‰©å±•åå’Œè·¯å¾„ï¼‰
            FILENAME=$(basename "$FILE")
            TITLE="${FILENAME%.md}"
            echo "ğŸ“‹ ä»æ–‡ä»¶åæå–æ ‡é¢˜ï¼š$TITLE"
            
            # ä»æ–‡ä»¶å†…å®¹è·å–æ ‡ç­¾
            LABELS=$(grep -E '^ISSUE_LABELS:' "$FILE" | sed 's/^ISSUE_LABELS:[[:space:]]*//' || echo "æ–‡æ¡£")
            
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤æ ‡ç­¾
            if [[ -z "$LABELS" ]]; then
              LABELS="æ–‡æ¡£"
            fi
            echo "ğŸ“‹ æå–æ ‡ç­¾ï¼š$LABELS"
            
            # å¤„ç†æ ‡ç­¾ï¼Œå°†é€—å·åˆ†éš”çš„æ ‡ç­¾è½¬æ¢ä¸ºæ•°ç»„
            LABEL_ARRAY=()
            IFS=',' read -ra TEMP_ARRAY <<< "$LABELS"
            for label in "${TEMP_ARRAY[@]}"; do
              # å»é™¤æ ‡ç­¾ä¸¤ç«¯çš„ç©ºæ ¼
              LABEL_ARRAY+=("$(echo "$label" | xargs)")
            done
            echo "ğŸ“‹ è§£æçš„æ ‡ç­¾ï¼š${LABEL_ARRAY[*]}"
            
            # ç¡®ä¿æ ‡ç­¾åœ¨ä»“åº“ä¸­å­˜åœ¨
            for label in "${LABEL_ARRAY[@]}"; do
              if ! echo "$EXISTING_LABELS" | grep -q "^$label$"; then
                echo "ğŸ·ï¸ åˆ›å»ºæ–°æ ‡ç­¾: $label"
                # åˆ›å»ºæ ‡ç­¾ï¼Œä½¿ç”¨éšæœºé¢œè‰²
                COLORS=("fc8403" "2cbe4e" "0075ca" "d73a4a" "6f42c1" "fbca04" "b60205" "5319e7" "0e8a16" "1d76db" "c5def5" "bfdadc")
                RANDOM_COLOR=${COLORS[$((RANDOM % ${#COLORS[@]}))]}
                gh label create "$label" --color "$RANDOM_COLOR" || true
              else
                echo "ğŸ·ï¸ æ ‡ç­¾å·²å­˜åœ¨: $label"
              fi
            done
            
            # ä»æ–‡ä»¶ä¸­æå–æ­£æ–‡å†…å®¹ï¼ˆè·³è¿‡æ ‡ç­¾è¡Œï¼‰
            # å°†å†…å®¹ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å…Shellå‘½ä»¤æ³¨å…¥å’Œç‰¹æ®Šå­—ç¬¦é—®é¢˜
            grep -v '^ISSUE_LABELS:' "$FILE" > /tmp/issue_body.md
            echo "ğŸ“‹ æå–æ­£æ–‡å†…å®¹é•¿åº¦ï¼š$(wc -c < /tmp/issue_body.md) å­—èŠ‚"

            # æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå issue
            ISSUE_NUMBER=$(gh issue list --state all --search "$TITLE in:title" --json number,title,state | jq -r ".[] | select(.title==\"$TITLE\") | .number")
            
            # å¦‚æœæ‰¾åˆ° issueï¼Œåˆ™æ›´æ–°ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„ issue
            if [[ -n "$ISSUE_NUMBER" ]]; then
              # è·å–issueçŠ¶æ€
              ISSUE_STATE=$(gh issue view "$ISSUE_NUMBER" --json state | jq -r '.state')
              echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå issue: '$TITLE'ï¼Œæ‰¾åˆ° issue number: $ISSUE_NUMBERï¼ŒçŠ¶æ€: $ISSUE_STATE"
              
              # å¦‚æœissueæ˜¯å…³é—­çŠ¶æ€ï¼Œå…ˆé‡æ–°æ‰“å¼€
              if [[ "$ISSUE_STATE" == "CLOSED" ]]; then
                echo "ğŸ”“ é‡æ–°æ‰“å¼€å·²å…³é—­çš„issue #$ISSUE_NUMBER"
                gh issue reopen "$ISSUE_NUMBER"
              fi
              
              echo "â™»ï¸ æ›´æ–°å·²å­˜åœ¨çš„ issue #$ISSUE_NUMBER"
              
              # æ›´æ–°issueå†…å®¹
              gh issue edit "$ISSUE_NUMBER" --body-file /tmp/issue_body.md
              
              # è·å–issueç°æœ‰æ ‡ç­¾
              CURRENT_LABELS=$(gh issue view "$ISSUE_NUMBER" --json labels | jq -r '.labels[].name')
              echo "ğŸ·ï¸ ç°æœ‰æ ‡ç­¾: $CURRENT_LABELS"
              
              # æ·»åŠ mdæ–‡ä»¶ä¸­çš„æ–°æ ‡ç­¾
              echo "ğŸ·ï¸ æ·»åŠ æ–°æ ‡ç­¾..."
              for label in "${LABEL_ARRAY[@]}"; do
                # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨äºissueä¸­
                if ! echo "$CURRENT_LABELS" | grep -q "^$label$"; then
                  echo "ğŸ·ï¸ æ·»åŠ æ–°æ ‡ç­¾: $label"
                  gh issue edit "$ISSUE_NUMBER" --add-label "$label"
                else
                  echo "ğŸ·ï¸ æ ‡ç­¾å·²å­˜åœ¨: $label"
                fi
              done
            else
              echo "ğŸ†• åˆ›å»ºæ–°çš„ issue: $TITLE"
              
              # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶åŒ…å«æ ‡ç­¾å‚æ•°
              LABEL_PARAMS=""
              for label in "${LABEL_ARRAY[@]}"; do
                LABEL_PARAMS+=" --label \"$label\""
              done
              
              # ä½¿ç”¨body-fileå’Œæ ‡ç­¾åˆ›å»ºissue
              eval "gh issue create -t \"$TITLE\" --body-file /tmp/issue_body.md $LABEL_PARAMS"
            fi

            echo "âœ… å®Œæˆï¼š$TITLE"
          done < "${{ env.ISSUES_FILES_LIST }}"