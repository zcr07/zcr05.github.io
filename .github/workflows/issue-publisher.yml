name: Publish Issues

on:
  push:
    paths:
      - 'issues/*.md'

permissions:
  contents: read
  issues: write

jobs:
  issue-publisher:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: ğŸ“‚ è·å–æœ¬æ¬¡æäº¤å˜æ›´çš„ issues/*.md æ–‡ä»¶
        id: get_changed_files
        run: |
          echo "ğŸ” å½“å‰ GITHUB_SHA: $GITHUB_SHA"
          echo "ğŸ“‹ å½“å‰æäº¤å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼š"
          # æ‰“å°å½“å‰å˜æ›´çš„æ–‡ä»¶
          git diff-tree --no-commit-id --name-only -r "$GITHUB_SHA"
          
          # è·å–å˜æ›´çš„ .md æ–‡ä»¶
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r "$GITHUB_SHA" | grep -E '^issues/.*\.md$' || true)
          
          echo "ğŸ“‚ æœ¬æ¬¡è·å–åˆ°çš„mdæ–‡ä»¶ï¼š$CHANGED_FILES"
          
          # è¾“å‡ºè·å–åˆ°çš„æ–‡ä»¶åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ”§ è°ƒè¯•å½“å‰å·¥ä½œç›®å½•åŠæ–‡ä»¶
        run: |
          echo "ğŸ“‚ å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          echo "ğŸ“‚ å½“å‰å·¥ä½œç›®å½•ä¸‹æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la
          
      - name: ğŸ“ å¤„ç†å˜æ›´çš„ issue æ–‡ä»¶
        if: ${{ env.CHANGED_FILES != '' }}
        run: |
          # è¾“å‡ºå˜æ›´æ–‡ä»¶çš„æ—¥å¿—
          echo "ğŸ“‚ å¤„ç†ä»¥ä¸‹å˜æ›´çš„ issue æ–‡ä»¶ï¼š"
          echo "$CHANGED_FILES"
          
          # éå†å˜æ›´çš„æ–‡ä»¶
          for file in $CHANGED_FILES; do
            echo "ğŸ” æ­£åœ¨å¤„ç†æ–‡ä»¶: $file"
            
            # æå–æ ‡é¢˜å’Œæ ‡ç­¾
            TITLE=$(head -n 1 "$file" | sed 's/^# //')
            BODY=$(tail -n +2 "$file")
            
            # æå–æ ‡ç­¾
            LABELS=$(grep -E '^ISSUE_LABELS:' "$file" | sed 's/^ISSUE_LABELS:[[:space:]]*//')
            
            echo "ğŸ“‹ è¯»å–åˆ°çš„æ ‡é¢˜: $TITLE"
            echo "ğŸ“‹ è¯»å–åˆ°çš„æ ‡ç­¾: $LABELS"
            
            # å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œè·³è¿‡
            if [[ -n "$LABELS" ]]; then
              echo "ğŸ“‹ æ ‡ç­¾åˆ—è¡¨: $LABELS"
            else
              echo "âŒ æ²¡æœ‰æ ‡ç­¾ï¼Œè·³è¿‡æ ‡ç­¾è®¾ç½®"
            fi

            # æ£€æŸ¥ issue æ˜¯å¦å·²å­˜åœ¨
            ISSUE_NUMBER=$(gh issue list \
              --state all \
              --search "$TITLE in:title" \
              --json number,title \
              | jq -r ".[] | select(.title==\"$TITLE\") | .number")
            
            if [[ -n "$ISSUE_NUMBER" ]]; then
              echo "â™»ï¸ æ›´æ–°å·²å­˜åœ¨çš„ issue #$ISSUE_NUMBER"
              gh issue edit "$ISSUE_NUMBER" --body "$BODY"
              
              # æ›´æ–°æ ‡ç­¾
              if [[ -n "$LABELS" ]]; then
                echo "ğŸ”§ æ›´æ–°æ ‡ç­¾ä¸º: $LABELS"
                gh issue edit "$ISSUE_NUMBER" --add-label "$LABELS"
              fi
            else
              echo "ğŸ†• åˆ›å»ºæ–°çš„ issue: $TITLE"
              gh issue create -t "$TITLE" -b "$BODY"
              
              # æ·»åŠ æ ‡ç­¾
              if [[ -n "$LABELS" ]]; then
                echo "ğŸ”§ ä¸ºæ–° issue æ·»åŠ æ ‡ç­¾: $LABELS"
                gh issue edit "$ISSUE_NUMBER" --add-label "$LABELS"
              fi
            fi

            echo "âœ… å®Œæˆï¼š$TITLE"
          done