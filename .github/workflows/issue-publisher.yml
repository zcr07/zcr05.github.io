name: Publish Issues

on:
  push:
    paths:
      - 'issues/*.md'

permissions:
  contents: read
  issues: write

jobs:
  issue-publisher:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: ğŸ“‚ è·å–æœ¬æ¬¡æäº¤å˜æ›´çš„ issues/*.md æ–‡ä»¶
        id: get_changed_files
        run: |
          echo "ğŸ” å½“å‰ GITHUB_SHA: $GITHUB_SHA"

          # è¾“å‡ºå½“å‰æäº¤çš„ diff åˆ—è¡¨
          echo "ğŸ“‹ å½“å‰æäº¤å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼š"
          git diff --name-only $GITHUB_SHA^ $GITHUB_SHA

          # è·å–å½“å‰æäº¤çš„å˜æ›´æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶è¿‡æ»¤å‡º issues/*.md æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only $GITHUB_SHA^ $GITHUB_SHA | grep -E '^issues/.*\.md$' || true)

          echo "ğŸ“‚ æœ¬æ¬¡è·å–åˆ°çš„mdæ–‡ä»¶ï¼š$CHANGED_FILES"

          # å¦‚æœæ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡åç»­æ“ä½œ
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "âœ… æœ¬æ¬¡æäº¤æ²¡æœ‰å˜æ›´ä»»ä½• issues/*.md æ–‡ä»¶ï¼Œè·³è¿‡å¤„ç†"
            exit 0
          fi

          # è¾“å‡ºå˜æ›´æ–‡ä»¶åˆ—è¡¨åˆ° GitHub Actions ç¯å¢ƒå˜é‡
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ“„ å¤„ç†æ¯ä¸ªå˜æ›´çš„mdæ–‡ä»¶
        id: process_files
        run: |
          # ä»ç¯å¢ƒå˜é‡ä¸­è·å–å˜æ›´çš„mdæ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES="${{ env.CHANGED_FILES }}"

          echo "ğŸ“‚ å¤„ç†å˜æ›´çš„mdæ–‡ä»¶ï¼š$CHANGED_FILES"

          for FILE in $CHANGED_FILES; do
            echo "ğŸ” å¤„ç†æ–‡ä»¶ï¼š$FILE"

            # ä»mdæ–‡ä»¶ä¸­æå–æ ‡é¢˜
            TITLE=$(head -n 1 "$FILE" | sed 's/^# //')
            echo "ğŸ“‹ æå–æ ‡é¢˜ï¼š$TITLE"

            # ä»mdæ–‡ä»¶ä¸­æå–æ­£æ–‡å†…å®¹
            BODY=$(tail -n +2 "$FILE")
            echo "ğŸ“‹ æå–æ­£æ–‡ï¼š$BODY"

            # ä»mdæ–‡ä»¶ä¸­æå–æ ‡ç­¾
            LABELS=$(grep -E '^ISSUE_LABELS:' "$FILE" | sed 's/^ISSUE_LABELS:[[:space:]]*//')
            echo "ğŸ“‹ æå–æ ‡ç­¾ï¼š$LABELS"

            # æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå issue
            ISSUE_NUMBER=$(gh issue list --state all --search "$TITLE in:title" --json number,title | jq -r ".[] | select(.title==\"$TITLE\") | .number")
            echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå issue: '$TITLE'ï¼Œæ‰¾åˆ° issue number: $ISSUE_NUMBER"

            # å¦‚æœæ‰¾åˆ° issueï¼Œåˆ™æ›´æ–°ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„ issue
            if [[ -n "$ISSUE_NUMBER" ]]; then
              echo "â™»ï¸ æ›´æ–°å·²å­˜åœ¨çš„ issue #$ISSUE_NUMBER"
              gh issue edit "$ISSUE_NUMBER" --body "$BODY" --label "$LABELS"
            else
              echo "ğŸ†• åˆ›å»ºæ–°çš„ issue: $TITLE"
              gh issue create -t "$TITLE" -b "$BODY" --label "$LABELS"
            fi

            echo "âœ… å®Œæˆï¼š$TITLE"
          done