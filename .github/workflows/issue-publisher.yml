name: Publish Issues

on:
  push:
    paths:
      - 'issues/*.md'

permissions:
  contents: read
  issues: write

jobs:
  publish_issues:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # å…è®¸ git diff æ¯”è¾ƒæœ€è¿‘ä¸¤æ¬¡æäº¤

      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Create or update GitHub Issues from markdown changes
        run: |
          echo "ğŸ“‚ è·å–æœ¬æ¬¡æäº¤å˜æ›´çš„ issues/*.md æ–‡ä»¶"
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep '^issues/.*\.md$' || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "âœ… æœ¬æ¬¡æäº¤æ²¡æœ‰å˜æ›´ä»»ä½• issues/*.md æ–‡ä»¶ï¼Œè·³è¿‡å¤„ç†"
            exit 0
          fi

          for file in $CHANGED_FILES; do
            if [[ ! -f "$file" ]]; then
              echo "âš ï¸ $file å·²è¢«åˆ é™¤ï¼Œè·³è¿‡"
              continue
            fi

            TITLE=$(basename "$file" .md | sed 's/[-_]/ /g')

            FIRST_LINE=$(head -n 1 "$file")
            if [[ "$FIRST_LINE" == ISSUE_LABELS:* ]]; then
              LABELS=$(echo "$FIRST_LINE" | sed 's/^ISSUE_LABELS:[[:space:]]*//')
              BODY=$(tail -n +2 "$file")
              echo "ğŸ” æ£€æŸ¥è·å–åˆ°çš„æ ‡ç­¾ï¼š'$LABELS'"
            else
              LABELS=""
              BODY=$(cat "$file")
            fi

            # è‡ªåŠ¨åˆ›å»ºç¼ºå¤±æ ‡ç­¾
            if [[ -n "$LABELS" ]]; then
              IFS=',' read -ra LABEL_ARR <<< "$LABELS"
              for label in "${LABEL_ARR[@]}"; do
                CLEAN_LABEL=$(echo "$label" | xargs)
                echo "ğŸ·ï¸ ç¡®ä¿æ ‡ç­¾ '$CLEAN_LABEL' å­˜åœ¨"
                gh label create "$CLEAN_LABEL" --description "Auto-created label" --color "ededed" 2>/dev/null || true
              done
            fi

            echo "ğŸ” æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå issue: '$TITLE'"
            ISSUE_NUMBER=$(gh issue list \
              --state all \
              --search "$TITLE in:title" \
              --json number,title \
              | jq -r ".[] | select(.title==\"$TITLE\") | .number")

            if [[ -n "$ISSUE_NUMBER" ]]; then
              echo "â™»ï¸ æ›´æ–°å·²å­˜åœ¨çš„ issue #$ISSUE_NUMBER"
              if [[ -n "$LABELS" ]]; then
                gh issue edit "$ISSUE_NUMBER" --body "$BODY" --add-label "$LABELS"
              else
                gh issue edit "$ISSUE_NUMBER" --body "$BODY"
              fi
            else
              echo "ğŸ†• åˆ›å»ºæ–°çš„ issue: $TITLE"
              if [[ -n "$LABELS" ]]; then
                gh issue create -t "$TITLE" -b "$BODY" --label "$LABELS"
              else
                gh issue create -t "$TITLE" -b "$BODY"
              fi
            fi

            echo "âœ… å®Œæˆå¤„ç†: $TITLE"
          done
        env:
          GH_TOKEN: ${{ github.token }}
